<html>
    <head>
        <script type="text/javascript" src="elliptic.min.js" language="javascript"></script> <!-- from https://github.com/indutny/elliptic -->
        <script type="text/javascript" src="crypto-api.min.js" language="javascript"></script> <!-- from https://github.com/nf404/crypto-api -->
        <script language="javascript">

if (location.protocol !== 'https:' && location.protocol !== 'file:') {
    location.replace(`https:${location.href.substring(location.protocol.length)}`);
}

function showPasswordField() {
    var f = document.getElementById("passwordField");
    f.type = ( f.type === "password" ? "text" : "password" );
}

function stripNumbers() {
    let x = document.getElementById("countryField");
    x.value = x.value.replace(/\D/g,'');
    let y = document.getElementById("numberField");
    y.value = y.value.replace(/\D/g,'');
}

function copyKey() {    
    var range = document.createRange();
    range.selectNode(document.getElementById("keyContent"));
    window.getSelection().removeAllRanges(); // clear current selection
    window.getSelection().addRange(range); // to select text
    document.execCommand("copy");
    window.getSelection().removeAllRanges();// to deselect
}

async function calculateKeyAndAddress(e) {
    e.preventDefault();

    const c = document.getElementById("countryField").value;
    const n = document.getElementById("numberField").value;

    if ((c+n).length < 6) {
      alert("Minimum allowed phone number length is 6 characters.");
      return;
    }

    const p = document.getElementById("passwordField").value;

    if (p.length < 4) {
      alert("Minimum possible password length is 4 characters.");
      return;
    }

    const concat = "" + c + n + p;
    const privKey = await sha256Hex(concat);
    
    document.getElementById("keyButton").innerHTML = "<button onclick='copyKey()'>Copy</button>";
    document.getElementById("keyContent").innerHTML = privKey;
    
    let ec = new elliptic.ec('secp256k1');
    const generatorPoint = ec.g;
    const pubKeyCoordinates = generatorPoint.mul(privKey);
    const x = pubKeyCoordinates.getX().toString('hex',64);
    const y = pubKeyCoordinates.getY().toString('hex',64);
    const lastY = y.slice(-1);
    const prefix = '02468ace'.indexOf(lastY) >= 0 ? '02' : '03';
    const pubKey = prefix + x;

    let shadKey = await sha256Hex(pubKey);

    let msgBuffer = new Uint8Array(shadKey.match(/[\da-f]{2}/gi).map(function (h) { return parseInt(h, 16); }));
    let mder = CryptoApi.getHasher('ripemd160');
    mder.update(CryptoApi.encoder.fromArrayBuffer(msgBuffer));
    const addSuffix = CryptoApi.encoder.toHex(mder.finalize());

    const mainnet = true;
    const addPrefix = mainnet ? '00' : '6F';
    const address = addPrefix + addSuffix;
    console.log("networked ripemd160 hash", address);
    
    const firstHash = await sha256Hex(address);
    const secondHash = await sha256Hex(firstHash);
    const checksum = secondHash.slice(0,8);

    const btcAddress = Uint8Array.from([...hexToBytes(address), ...hexToBytes(checksum)]);
    const b58Address = to_b58(btcAddress);
    document.getElementById("addressContent").innerHTML = b58Address;
    return false;
}

async function sha256Hex(hexString) {
    let msgBuffer = new Uint8Array(hexString.match(/[\da-f]{2}/gi).map(function (h) { return parseInt(h, 16); }));
    let hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    let hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => ('00' + b.toString(16)).slice(-2)).join('');
}

function hexToBytes(hexString) {
  return new Uint8Array(hexString.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
}

function to_b58(B) {
    const A = "123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";
    var d = [], s = "", i, j, c, n;
    for (i in B) {
        j = 0;
        c = B[i];
        s += c || s.length ^ i ? "" : 1;
        while(j in d || c) {
            n = d[j];
            n = n ? n * 256 + c : c;
            c = n / 58 | 0;
            d[j] = n % 58;
            j++;
        }
    }
    while(j--)
        s += A[d[j]];
    return s;
}

if (!window.crypto.subtle) {
    alert("Old browser! No WebCrypto API! Do not use!");
    document.getElementById("submitButton").remove();
    //TODO redirect to something which imports Stanford Crypto Library or the like
}

        </script>
    </head>
    <body>
        <h1>BTextC</h1>
        <h2>Receive Bitcoin</h2>
        (<a href="send.html">click here to send</a>)
        <p/>
        <h3>Instructions</h3>
        If you're here, someone probably sent you some Bitcoin, along with a password. That bitcoin has been put in what
        is sometimes called an "address," but you can think of as a treasure chest. Use the form below to enter your phone number
        and the password you received, in order to get the key to that treasure chest, known as the "private key."
        <p/>
        Please note that the "private key" is just a string of numbers and letters, and <i>anyone who has it</i> can use it to
        unlock this treasure chest and take its contents -- so keep it secret. In the unlikely event it turns out to be empty,
        well, maybe someone stole it ... or maybe whoever texted you that they were going to put the bitcoin in the chest never
        actually got around to it. Probably best to check with them, if so.
        <p/>
        Once you have the private key, you'll probably want to move it into a more secure "wallet." See the <i>What To Do With
        Your Money</i> section below for details.
        <form method="post" onsubmit="return calculateKeyAndAddress(event);">
            <input id="countryField" type="text" name="countryCode" onchange="stripNumbers();" placeholder="Country code"></input>
            <input id="numberField" type="text" name="number" onchange="stripNumbers();" placeholder="Phone number"></input>
            <input id="passwordField" type="password" name="password" placeholder="Password"></input>
            <a href="#" style="text-decoration:none" onclick="showPasswordField();">üëÅÔ∏è</a>
            <input type="submit">
        </form>
        <h3>Private Key</h3>
        <div id="keyWrapper"><span id="keyButton"></span> <span id="keyContent"></span></div>
        <h3>Address</h3>
        <div id="addressContent"></div>
        <br/>
        <div>(You can use sites like <a href="https://www.blockchain.com/explorer">blockchain.com</a> to see the history of all transactions for any Bitcoin address.)</div>
        <h3>What To Do With Your Money</h3>
        <UL>
            <LI>
              <b>Wallets</b>
              <br/>
              The first thing you'll probably want to do is move the money into a Bitcoin wallet, which is basically another
              "treasure chest," but one which comes with a lot of tools and safeguards built into and around it. Most Bitcoin
              wallets let you directly import a private key. Instructions for the most popular ones follow:
              <UL>
                <LI>
                  <i><a href="https://bitcoinelectrum.com/">Electrum</a>:</i> Follow the instructions in
                  "<a href="https://bitcoinelectrum.com/importing-your-private-keys-into-electrum/">Importing Your Private Keys Into Electrum</a>."
                </LI>
              </UL>
            </LI>
            <p/>
            <LI>
              <b>Exchanges</b>
              <br/>
              Once you have the bitcoin in a wallet, you can sell it for your own currency at an exchange.
              (Exchanges don't allow you to directly import a private key.)
            </LI>
        </UL>
    </body>
</html>