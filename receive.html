<html>
    <head>
        <script language="javascript">

if (location.protocol !== 'https:' && location.protocol !== 'file:') {
    location.replace(`https:${location.href.substring(location.protocol.length)}`);
}

function showPasswordField() {
    var f = document.getElementById("passwordField");
    if (f.type === "password") {
        f.type = "text";
    } else {
        f.type = "password";
    }
}

function stripNumbers() {
    let x = document.getElementById("countryField");
    x.value = x.value.replace(/\D/g,'');
    let y = document.getElementById("numberField");
    y.value = y.value.replace(/\D/g,'');
}

async function calculateKeyAndAddress(e) {
    e.preventDefault();
    const x = document.getElementById("countryField").value;
    const y = document.getElementById("numberField").value;
    const z = document.getElementById("passwordField").value;
    const concat = "" + x + y + z;
    console.log("concat", concat);
    const privKey = await sha256(concat);
    console.log("privKey", privKey);
    
    document.getElementById("keyButton").innerHTML = "<button onclick='copyKey()'>Copy</button>";
    document.getElementById("keyContent").innerHTML = privKey;
    return false;
}

async function sha256(message) {
    const msgBuffer = new TextEncoder('utf-8').encode(message);                    
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => ('00' + b.toString(16)).slice(-2)).join('');
    return hashHex;
}

if (!window.crypto.subtle) {
    alert("Old browser! No WebCrypto API! Do not use!");
    //TODO redirect to something which imports Stanford Crypto Library or the like
}

function copyKey() {    
    var range = document.createRange();
    range.selectNode(document.getElementById("keyContent"));
    window.getSelection().removeAllRanges(); // clear current selection
    window.getSelection().addRange(range); // to select text
    document.execCommand("copy");
    window.getSelection().removeAllRanges();// to deselect
}

        </script>
    </head>
    <body>
        <h1>Texthereum</h1>
        <h2>Receive</h2>
        <form method="post" onsubmit="return calculateKeyAndAddress(event);">
        <input id="countryField" type="text" name="countryCode" onchange="stripNumbers();" placeholder="Country code"></input>
        <input id="numberField" type="text" name="number" onchange="stripNumbers();" placeholder="Phone number"></input>
        <input id="passwordField" type="password" name="password" placeholder="Password"></input>
        <a href="#" style="text-decoration:none" onclick="showPasswordField();">üëÅÔ∏è</a>
        <input type="submit">
        </form>
        <h3>Private Key</h3>
        <div id="keyWrapper"><span id="keyButton"></span> <span id="keyContent"></span></div>
    </body>
</html>