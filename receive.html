<html>
    <head>
        <script language="javascript">

if (location.protocol !== 'https:' && location.protocol !== 'file:') {
    location.replace(`https:${location.href.substring(location.protocol.length)}`);
}

function showPasswordField() {
    var f = document.getElementById("passwordField");
    if (f.type === "password") {
        f.type = "text";
    } else {
        f.type = "password";
    }
}

function stripNumbers() {
    let x = document.getElementById("countryField");
    x.value = x.value.replace(/\D/g,'');
    let y = document.getElementById("numberField");
    y.value = y.value.replace(/\D/g,'');
}

function copyKey() {    
    var range = document.createRange();
    range.selectNode(document.getElementById("keyContent"));
    window.getSelection().removeAllRanges(); // clear current selection
    window.getSelection().addRange(range); // to select text
    document.execCommand("copy");
    window.getSelection().removeAllRanges();// to deselect
}

async function calculateKeyAndAddress(e) {
    e.preventDefault();

    const c = document.getElementById("countryField").value;
    const n = document.getElementById("numberField").value;

    if ((c+n).length < 6) {
      alert("Minimum allowed phone number length is 6 characters.");
      return;
    }

    const p = document.getElementById("passwordField").value;

    if (p.length < 4) {
      alert("Minimum possible password length is 4 characters.");
      return;
    }


    const concat = "" + c + n + p;
    const privKey = await sha256(concat);
    
    document.getElementById("keyButton").innerHTML = "<button onclick='copyKey()'>Copy</button>";
    document.getElementById("keyContent").innerHTML = privKey;
    return false;
}

async function sha256(message) {
    const msgBuffer = new TextEncoder('utf-8').encode(message);                    
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => ('00' + b.toString(16)).slice(-2)).join('');
    return hashHex;
}

if (!window.crypto.subtle) {
    alert("Old browser! No WebCrypto API! Do not use!");
    ocument.getElementById("submitButton").remove();
    //TODO redirect to something which imports Stanford Crypto Library or the like
}

        </script>
    </head>
    <body>
        <h1>Texthereum</h1>
        <h2>Receive</h2>
        <h3>Instructions</h3>
        If you're here, someone probably sent you some cryptocurrency, along with a password. That currency has been put in what
        is sometimes called an "address," but you can think of as a treasure chest. Use the form below to enter your phone number
        and the password you received, in order to get the key to that treasure chest, known as the "private key."
        <p/>
        Please note that the "private key" is just a string of numbers and letters, and <i>anyone who has it</i> can use it to
        unlock this treasure chest and take its contents -- so keep it secret. In the unlikely event it turns out to be empty,
        well, maybe someone stole it ... or maybe whoever texted you that they were going to put the money in the chest never
        actually got around to it. Probably best to check with them, if so.
        <p/>
        Once you have the private key, you'll probably want to move it into a more secure "wallet." See the <i>What To Do With
        Your Money</i> section below for details.
        <form method="post" onsubmit="return calculateKeyAndAddress(event);">
        <input id="countryField" type="text" name="countryCode" onchange="stripNumbers();" placeholder="Country code"></input>
        <input id="numberField" type="text" name="number" onchange="stripNumbers();" placeholder="Phone number"></input>
        <input id="passwordField" type="password" name="password" placeholder="Password"></input>
        <a href="#" style="text-decoration:none" onclick="showPasswordField();">üëÅÔ∏è</a>
        <input type="submit">
        </form>
        <h3>Private Key</h3>
        <div id="keyWrapper"><span id="keyButton"></span> <span id="keyContent"></span></div>
        <h3>What To Do With Your Money</h3>
        <UL>
            <LI>Wallets</LI>
            <LI>Exchanges</LI>
        </UL>
    </body>
</html>